{% extends "registration/master.html" %}

{% load registration_tags %}

{% block content %}
<div class="modal fade" id="ageModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Why do we need your birthdate?</h4>
      </div>
      <div class="modal-body">
        {% if event.allowOnlineMinorReg %}
          <p>Anyone under the age of 18 (by the start of the convention) must have a parent or guardian present at the door to sign our consent form.</p>
          <p>A parent or guardian must register and accompany anyone under the age of 13 (by the start of the convention).</p>
          <p>Please contact <a href="mailto:{{event.registrationEmail}}">{{event.registrationEmail}}</a> if you have any questions.</p>
        {% else %}
          <p>Only those over the age of 18 (by the start of the convention) may register online.</p>
          <p>A parent or legal guardian must be present at the door to register anybody who will be under 18 at the time of the event (born after April 20, 2000). A parent or guardian must also register for the convention to accompany anyone under the age of 13 at the time of the event (born after April 20, 2005).</p>
          <p>Please contact <a href="mailto:{{event.registrationEmail}}">{{event.registrationEmail}}</a> if you have any questions.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

    <form class="form-horizontal" role="form" data-toggle="validator">
    <div class="tab-content">
    <div role="tabpanel" class="tab-pane fade in active" id="personal">
        <h1>{{event}}<small>&nbsp;Registration</small></h1>
        <p>Required fields are marked with a red asterisk (<span style="color:red;">*</span>).</p>

            {% show_attendee_form event=event emailOptions=True %}

        <h3><a name="level"></a>Select your Membership Type</h3>
        <hr>
          {% show_price_types %}
        <div class="container-fluid">
    		<div class="row" id="levelContainer">
                <noscript>Javascript is required for this site.</noscript>
                <div id="levelContainerAlert" class="alert alert-danger" style="display:none">
                    <b>No price levels have been set up yet!</b>
                    If you are the site administrator, you'll need to <a href="{% url 'admin:registration_pricelevel_add' %}">add some</a> before this form will work.
                </div>
            </div>
        </div>
		<hr>		
             <div>
                    <div>
                        <label>
                            <input type="checkbox" id="agreeToRules" name="agreeToRules" class="form-control-checkbox" required>
			I agree to abide by the {{ event.name }} <a href="{{ event.codeOfConduct }}" target="_blank">Code of Conduct</a>.
                        </label>
                    </div>
		    <div class="col-sm-offset-3 help-block with-errors"style=" padding-left:15px;"></div>
		</div>
		<div class="container-fluid">
       	    <button type="submit" class="btn btn-primary col-sm-6 pull-right" id="register">Register</button> &nbsp;
        </div>
	</div>
	</div>
	{% csrf_token %}
	</form>

{% endblock %}

{% block javascript %}

<script type="text/html" id="levelTemplate">
    <div id="levelTemplateColumn" class="col-xs-12 col-sm-6 col-md-6 col-lg-4">
    <div class="panel price">
        <div class="panel-heading  text-center">
        <h3 data-content="name"></h3>
        </div>
        <div class="panel-body text-center">
            <p class="lead" style="font-size:40px"><strong data-content="price"></strong></p>
        </div>
        <div class="panel-footer">
            <a class="btn btn-lg btn-block btn-primary selectLevel" data-id="levelId">Select</a>
            <a class="btn btn-default btn-block changeLevel">Change Level?</a>
        </div>
    </div>
    </div>
</script>





<script type="text/javascript" src="/static/js/templates/price-types.js"></script>
 <script type="text/javascript">
    var levelTemplateData = [];
    var levelData = [];
    var deptData = [];
    var shirtSizes = [];
    
    

    $( "body" ).ready(function() {
        // only init the javascript datepicker if none is provided by the browser natively
        if (!Modernizr.inputtypes.date) {
            $("#birthDate").datepicker({
                format: 'yyyy-mm-dd',
                changeMonth: true,
                changeYear: true
            });
        }
   
        $.getJSON("{% url 'departments' %}", function(data) {
            deptData = data;
            $.each(data, function(key, val) {
                $("#volunteer").append("<option value='" + val.id + "'>" + val.name + "</option>");
            });
        });
        $.getJSON("{% url 'shirtsizes' %}", function(data) {
            shirtSizes = data;
        });
    });





    $("#register").click(function(e) {
        e.preventDefault();
        $("form").validator('validate');
        var errorCount = $(".has-error").length;
        if (errorCount > 0) {return;}
        if ($("#birthDate").val() == "") {
            alert("You must enter your birthdate to submit your registration.");
            return;
        }
        if (Modernizr.inputtypes.date) {
            // native datepicker - EXPECT iso date
            var birthdate = parseDate($("#birthDate").val());
        } else {
            // American middle-endian format put out by datepicker javascript
            var birthdate = new Date(Date.parse($("#birthDate").val()));
        }

      {% if not event.allowOnlineMinorReg %}
        var age = getAge(birthdate);
        if (age < 18) {
            alert("You must be 18 by the first day of {{event}} to register online.")
            return;
        }
      {% endif %}
        var data = {
            'attendee': {
                'firstName': $("#firstName").val(), 'lastName': $("#lastName").val(), 
                'address1': $("#add1").val(), 'address2': $("#add2").val(), 'city': $("#city").val(), 
                'state': $("#state").val(), 'country': $("#country").val(), 'postal': $("#zip").val(),
                'phone': $("#phone").val(), 'email': $("#email").val(), 'birthdate': $("#birthDate").val(),
                'badgeName': $("#badgeName").val(), 'emailsOk': $("#contact").is(':checked'), 
                'volDepts': $("#volunteer").val(), 'surveyOk': $("#survey").is(':checked'),
                'asl': false,
            }, 
            'priceLevel': { 'id': $(".selectLevel")[0].id.split('_')[1], 'options': getOptions() },
            'event': '{{event}}'
        };
        $.ajax({
            "type": "POST",
            "dataType": "json",
            "url": "{% url 'addToCart' %}",
            "data": JSON.stringify(data),
            "beforeSend": function(xhr, settings) {
                console.log("Before Send");
                $.ajaxSettings.beforeSend(xhr, settings);
            },
            "success": function(result) {
                if (result.success) {
                    window.location = "{% url 'cart' %}";
                } else {
                    alert(result.message);
                }
            },
            "error": function(result, status) {
                alert("An error has occurred. Please contact {{ event.registrationEmail }} and we will correct the problem.")
            }
        })

    });

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    }
});

$(document).on("click",".open-image", function(event){
	window.open($(event.target).data("image"),"_blank","width=750,height=750,left=35%,top=25%,menubar=no,statusbar=no");
});

</script>


{% endblock %}
